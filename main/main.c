#include <stdio.h>
#include "sdkconfig.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_system.h"
#include "esp_spi_flash.h"
#include "chacha20.h"

void app_main(void)
{
    printf("Hello world!\n");
    
    uint8_t key[32] = {0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f};
    uint8_t nonce[12] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02};
    uint64_t counter = 0;
    struct chacha20_context ctx;
    uint8_t msg[128] = {0x27,0x54,0x77,0x61,0x73,0x20,0x62,0x72,0x69,0x6c,0x6c,0x69,0x67,0x2c,0x20,0x61,0x6e,0x64,0x20,0x74,0x68,0x65,0x20,0x73,0x6c,0x69,0x74,0x68,0x79,0x20,0x74,0x6f,0x76,0x65,0x73,0x0a,0x44,0x69,0x64,0x20,0x67,0x79,0x72,0x65,0x20,0x61,0x6e,0x64,0x20,0x67,0x69,0x6d,0x62,0x6c,0x65,0x20,0x69,0x6e,0x20,0x74,0x68,0x65,0x20,0x77,0x61,0x62,0x65,0x3a,0x0a,0x41,0x6c,0x6c,0x20,0x6d,0x69,0x6d,0x73,0x79,0x20,0x77,0x65,0x72,0x65,0x20,0x74,0x68,0x65,0x20,0x62,0x6f,0x72,0x6f,0x67,0x6f,0x76,0x65,0x73,0x2c,0x0a,0x41,0x6e,0x64,0x20,0x74,0x68,0x65,0x20,0x6d,0x6f,0x6d,0x65,0x20,0x72,0x61,0x74,0x68,0x73,0x20,0x6f,0x75,0x74,0x67,0x72,0x61,0x62,0x65,0x2e};
    const size_t msgLen = 128;
    for (int i = 0; i < msgLen; i++) {
        printf("%x", msg[i]);
    }
    printf("\n");
    //printf("\nSTEP 1\n");
    chacha20_init_context(&ctx, key, nonce, counter);
    // for (int i=0;i < (sizeof (ctx.state) /sizeof (ctx.state[0]));i++) {
    //     printf("%d ",ctx.state[i]);
    // }
    printf("\n");
    chacha20_xor(&ctx, &msg, msgLen);
    for (int i = 0; i < msgLen; i++) {
        printf("%x", msg[i]);
    }
    printf("\n");




    for (int i = 10; i >= 0; i--) {
        printf("Restarting in %d seconds...\n", i);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
    printf("Restarting now.\n");
    fflush(stdout);
    esp_restart();
}

void print_esp_info() {
    /* Print chip information */
    esp_chip_info_t chip_info;
    esp_chip_info(&chip_info);
    printf("This is %s chip with %d CPU core(s), WiFi%s%s, ",
            CONFIG_IDF_TARGET,
            chip_info.cores,
            (chip_info.features & CHIP_FEATURE_BT) ? "/BT" : "",
            (chip_info.features & CHIP_FEATURE_BLE) ? "/BLE" : "");

    printf("silicon revision %d, ", chip_info.revision);

    printf("%dMB %s flash\n", spi_flash_get_chip_size() / (1024 * 1024),
            (chip_info.features & CHIP_FEATURE_EMB_FLASH) ? "embedded" : "external");

    printf("Minimum free heap size: %d bytes\n", esp_get_minimum_free_heap_size());

}